name: CI/CD Pipeline

on:
  push:
    branches:
      - master

jobs:
  build_and_deploy:
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    strategy:
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build project
        env:
          NODE_OPTIONS: "--max_old_space_size=16000"
          PORT: 3001
          REACT_APP_API: https://api.shanovina.com
          REACT_APP_WEB: https://admin.shanovina.com
          ESLINT_NO_DEV_ERRORS: true
          DISABLE_ESLINT_PLUGIN: true
        run: |
          # Example build commands for a Node.js project
          cd temp
          npm install
          npm run build
          tar -cvzf temp_build.gz build
          tar -cvzf temp_node_modules.gz node_modules          

      - name: Copy build to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.PASSPHRASE }}
          source: "./temp/temp_build.gz,./temp/temp_node_modules.gz"
          target: "/home/ubuntu/admin-tcgplayer" 

      - name: Excute and Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.PASSPHRASE }}
          script: |
            cd admin-tcgplayer
            git pull origin master
            # tar -xvzf dist.gz
            # tar -xvzf node_modules.gz
            tar -xvzf temp_build.gz ./temp
            tar -xvzf temp_node_modules.gz ./temp
            pm2 restart admin-tcgplayer
            # rm dist.gz
            # rm node_modules.gz
            # rm temp_build.gz
            # rm temp_node_modules.gz